<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial‑scale=1.0"/>
  <title>Ping Pong</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:#111;color:#fff;font-family:sans-serif;overflow:hidden;}
    canvas{display:block;margin:2rem auto;background:#222;border:2px solid #0ff;}
    #scoreUI{position:absolute;top:1rem;left:50%;transform:translateX(-50%);font-size:2rem;}
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>

  <div id="scoreUI">0 – 0</div>
  <canvas id="canvas" width="900" height="500"></canvas>

  <script>
  (async()=>{
    // — 1) clientId (lobby ile aynı)
    let cid = sessionStorage.getItem('clientId');
    if(!cid) sessionStorage.setItem('clientId', cid = crypto.randomUUID());

    // — 2) URL’den table
    const ps = new URLSearchParams(location.search);
    const table = ps.get('table');
    if(!table){ alert('Oda belirtilmemiş'); return; }

    // — 3) Firebase init
    const cfg = {
      apiKey: "AIzaSyASZrCdc3xrJ8iXagE3iMUdhEpPR5FiJOE",
      authDomain: "masa-tenisi-v1.firebaseapp.com",
      databaseURL: "https://masa-tenisi-v1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "masa-tenisi-v1",
    };
    firebase.initializeApp(cfg);
    const db = firebase.database();

    // — 4) Rol kontrolü
    const slotSnap = await db.ref(`lobby/tables/${table}`).once('value');
    const slot = slotSnap.val()||{};
    let role = null;
    if(slot.p1===cid) role='p1';
    else if(slot.p2===cid) role='p2';
    else { alert('Bu masada yeriniz yok'); return; }

    // — 5) Oyun state referansları
    const stateRef = db.ref(`games/${table}/state`);
    const W=900, H=500, PH=100, PW=12, BR=10, SPEED=5, FPS=60;
    // Local cache
    let state = {
      ball:{x:W/2,y:H/2,dx:SPEED,dy:SPEED},
      p1:{y:(H-PH)/2}, p2:{y:(H-PH)/2},
      s1:0, s2:0, playing:true
    };

    // — 6) Eğer host ve state yoksa initialize
    const initSnap = await stateRef.once('value');
    if(role==='p1' && !initSnap.exists()){
      await stateRef.set(state);
    }

    // — 7) Dinle ve render
    const canvas = document.getElementById('canvas');
    const ctx    = canvas.getContext('2d');
    const scoreUI= document.getElementById('scoreUI');

    stateRef.on('value',snap=>{
      const v=snap.val();
      if(!v) return;
      state = {
        ball:v.ball, p1:v.p1, p2:v.p2,
        s1:v.s1, s2:v.s2, playing:v.playing
      };
      scoreUI.textContent = `${state.s1} – ${state.s2}`;
    });

    function render(){
      ctx.clearRect(0,0,W,H);
      // paddles
      ctx.fillStyle = '#0ff';
      ctx.fillRect(0, state.p1.y, PW, PH);
      ctx.fillStyle = '#f0f';
      ctx.fillRect(W-PW, state.p2.y, PW, PH);
      // ball
      ctx.fillStyle='#ff0';
      ctx.beginPath();
      ctx.arc(state.ball.x, state.ball.y, BR, 0, 2*Math.PI);
      ctx.fill();
    }
    requestAnimationFrame(function loop(){
      render();
      if(state.playing) requestAnimationFrame(loop);
    });

    // — 8) Host fizik döngüsü
    if(role==='p1'){
      setInterval(()=>{
        if(!state.playing) return;
        let b = {...state.ball};
        b.x += b.dx; b.y += b.dy;
        // duvar
        if(b.y<BR||b.y>H-BR) b.dy*=-1;
        // sol
        if(b.x< PW+BR){
          if(b.y<state.p1.y||b.y>state.p1.y+PH) state.s2++;
          else b.dx = Math.abs(b.dx);
          b.x = W/2; b.y = H/2;
        }
        // sağ
        if(b.x>W-PW-BR){
          if(b.y<state.p2.y||b.y>state.p2.y+PH) state.s1++;
          else b.dx = -Math.abs(b.dx);
          b.x = W/2; b.y = H/2;
        }
        // skor kontrol
        if(state.s1>=7||state.s2>=7) state.playing=false;
        // DB’ye yaz
        stateRef.set({
          ball:b,
          p1:state.p1, p2:state.p2,
          s1:state.s1, s2:state.s2,
          playing:state.playing
        });
      },1000/FPS);
    }

    // — 9) Kontroller
    function sendY(y){
      const yy = Math.max(0, Math.min(H-PH, y));
      stateRef.child(role).child('y').set(yy);
    }

    // klavye
    window.addEventListener('keydown',e=>{
      if(role!=='p1') return;
      if(e.key==='w'||e.key==='ArrowUp')   sendY(state.p1.y-20);
      if(e.key==='s'||e.key==='ArrowDown') sendY(state.p1.y+20);
    });

    // fare
    if(role==='p2'){
      canvas.addEventListener('mousemove', e=>{
        const r=canvas.getBoundingClientRect();
        sendY(e.clientY-r.top-PH/2);
      });
    }

  })();
  </script>
</body>
</html>
