<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Realtime Ping Pong</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width:100%; height:100%; background:#000; color:#fff; font-family:Arial,sans-serif; display:flex; flex-direction:column; }
    header { padding:1rem; display:flex; justify-content:space-between; font-size:1.2rem; }
    .arena { position:relative; margin:auto; width:900px; height:600px; border:3px dashed #fff; }
    .paddle, .ball { position:absolute; background:#fff; }
    .paddle { width:12px; height:85px; }
    #paddle1 { left:0; }
    #paddle2 { right:0; }
    .ball { width:15px; height:15px; border-radius:50%; }
    #touchpad { position:fixed; bottom:0; left:50%; width:900px; height:100px; background:rgba(255,255,255,0.1); transform:translateX(-50%); touch-action:none; display:none; }
    #touchpad::before { content:''; position:absolute; left:50%; top:10px; width:4px; height:80px; background:rgba(255,255,255,0.3); transform:translateX(-50%); }
    @media(max-width:950px) { .arena, #touchpad { width:100%; } }

    /* bildirim kutucuğu */
    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 1rem 1.5rem;
      border-radius: 5px;
      font-size: 1rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity .4s ease;
    }
    #toast.show {
      opacity: 1;
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>

  <header>
    <div>P1: <strong id="score1">0</strong></div>
    <div style="font-family:monospace;">Realtime Ping Pong</div>
    <div>P2: <strong id="score2">0</strong></div>
  </header>

  <div class="arena" id="arena">
    <div class="paddle" id="paddle1"></div>
    <div class="paddle" id="paddle2"></div>
    <div class="ball"   id="ball"></div>
  </div>

  <div id="touchpad"></div>
  <div id="toast"></div>

  <script>
  (function(){
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyASZrCdc3xrJ8iXagE3iMUdhEpPR5FiJOE",
      authDomain: "masa-tenisi-v1.firebaseapp.com",
      databaseURL: "https://masa-tenisi-v1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "masa-tenisi-v1",
      storageBucket: "masa-tenisi-v1.appspot.com",
      messagingSenderId: "186015084983",
      appId: "1:186015084983:web:86f9d88e907423f5e33832"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // URL param helper
    function qs(key, def){
      const p = new URLSearchParams(location.search);
      return p.get(key) || def;
    }

    // rol & kontrol modu sor
    const room = qs('room','main');
    const role = parseInt(prompt(
      "Role seçin:\n1) Player 1 (host)\n2) Player 2\n3) Viewer"
    ),10) || 3;
    const ctrl = parseInt(prompt(
      "Control modu seçin:\n1) Klavye\n2) Fare\n3) Dokunmatik (touchpad)"
    ),10) || 1;

    // elemanlar
    const arenaE = document.getElementById('arena');
    const pad1E  = document.getElementById('paddle1');
    const pad2E  = document.getElementById('paddle2');
    const ballE  = document.getElementById('ball');
    const s1E    = document.getElementById('score1');
    const s2E    = document.getElementById('score2');
    const tpE    = document.getElementById('touchpad');
    const toastE = document.getElementById('toast');

    const W = arenaE.clientWidth, H = arenaE.clientHeight;
    const pw=12, ph=85, br=15, win=5;

    // tatlı bildirim (toast)
    function showToast(msg){
      toastE.textContent = msg;
      toastE.classList.add('show');
      setTimeout(()=> toastE.classList.remove('show'), 2000);
    }

    // lokal state (host)
    let vx, vy;
    let local = {
      p1:(H-ph)/2,
      p2:(H-ph)/2,
      x:(W-br)/2,
      y:(H-br)/2,
      s1:0, s2:0
    };

    // host ilk yazma
    if(role===1){
      vx=5; vy=5;
      db.ref(`rooms/${room}`).set(local);
    }

    // touchpad göster
    if(ctrl===3 && (role===1||role===2)) tpE.style.display='block';

    // input handling
    function clampPs(){
      local.p1 = Math.max(0,Math.min(H-ph,local.p1));
      local.p2 = Math.max(0,Math.min(H-ph,local.p2));
    }
    function writePaddles(){
      db.ref(`rooms/${room}`).update({ p1:local.p1, p2:local.p2 });
    }

    if(role===1||role===2){
      if(ctrl===1){ // klavye
        window.addEventListener('keydown', e=>{
          if(role===1){
            if(e.key==='w') local.p1-=6;
            if(e.key==='s') local.p1+=6;
          }
          if(role===2){
            if(e.key==='ArrowUp')   local.p2-=6;
            if(e.key==='ArrowDown') local.p2+=6;
          }
          clampPs(); writePaddles();
        });
      }
      if(ctrl===2){ // fare
        window.addEventListener('mousemove', e=>{
          const r=arenaE.getBoundingClientRect();
          const y=e.clientY-r.top-ph/2;
          if(role===1) local.p1=y; else local.p2=y;
          clampPs(); writePaddles();
        });
      }
      if(ctrl===3){ // touchpad
        tpE.addEventListener('touchmove', e=>{
          e.preventDefault();
          const t=e.touches[0], r=tpE.getBoundingClientRect();
          const pct=(t.clientX-r.left)/r.width;
          const y=pct*(H-ph);
          if(role===1) local.p1=y; else local.p2=y;
          clampPs(); writePaddles();
        });
      }
    }

    // host fizik + skor
    let hostLoop;
    if(role===1){
      hostLoop = setInterval(()=>{
        local.x+=vx; local.y+=vy;
        if(local.y<=0||local.y>=H-br) vy=-vy;
        // sol
        if(local.x<=pw){
          if(local.y+br>local.p1&&local.y<local.p1+ph) vx=-vx;
          else{ local.s2++; scoreReset(); }
        }
        // sağ
        if(local.x>=W-br-pw){
          if(local.y+br>local.p2&&local.y<local.p2+ph) vx=-vx;
          else{ local.s1++; scoreReset(); }
        }
        // kazanan?
        if(local.s1>=win||local.s2>=win){
          showToast((local.s1>local.s2?'Player 1':'Player 2')+" kazandı!");
          local.s1=local.s2=0;
        }
        db.ref(`rooms/${room}`).set(local);
      },16);
    }

    function scoreReset(){
      clearInterval(hostLoop);
      showToast("Gol!");
      setTimeout(()=>{
        local.x=(W-br)/2; local.y=(H-br)/2;
        vx = 5*(Math.random()<0.5?1:-1);
        vy = 5*(Math.random()<0.5?1:-1);
        hostLoop = setInterval(hostLoop._onTimeout,16);
      },1000);
    }

    // render (herkes)
    db.ref(`rooms/${room}`).on('value', snap=>{
      const st=snap.val();
      if(!st) return;
      pad1E.style.top=st.p1+'px';
      pad2E.style.top=st.p2+'px';
      ballE.style.left=st.x+'px'; ballE.style.top=st.y+'px';
      s1E.textContent=st.s1; s2E.textContent=st.s2;
      if(role===1) local=st;
    });

  })();
  </script>
</body>
</html>
