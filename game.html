<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ping Pong Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:#000;color:#fff;font-family:sans-serif;overflow:hidden;}
    header{display:flex;justify-content:space-between;padding:1rem;}
    .arena{position:relative;margin:auto;width:900px;height:600px;border:3px dashed #fff;}
    .paddle{position:absolute;width:12px;height:85px;background:#fff;}
    #paddle1{left:0;} #paddle2{right:0;}
    .ball{position:absolute;width:15px;height:15px;border-radius:50%;background:#fff;}
    #touchpad{position:fixed;bottom:0;left:50%;width:900px;height:100px;background:rgba(255,255,255,0.1);transform:translateX(-50%);display:none;touch-action:none;}
    #touchpad::before{content:'';position:absolute;left:50%;top:10px;width:4px;height:80px;background:rgba(255,255,255,0.3);transform:translateX(-50%);}
    @media(max-width:950px){.arena,#touchpad{width:100%;}}

    /* toast */
    #toast {
      position:fixed;bottom:20px;right:20px;
      background:rgba(0,0,0,0.8);color:#fff;
      padding:1rem 1.5rem;border-radius:5px;
      opacity:0;pointer-events:none;
      transition:opacity .4s;
    }
    #toast.show { opacity:1; }
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>
  <header>
    <div>P1: <strong id="score1">0</strong></div>
    <div style="font-family:monospace;">Realtime Ping Pong</div>
    <div>P2: <strong id="score2">0</strong></div>
  </header>
  <div class="arena" id="arena">
    <div class="paddle" id="paddle1"></div>
    <div class="paddle" id="paddle2"></div>
    <div class="ball"   id="ball"></div>
  </div>
  <div id="touchpad"></div>
  <div id="toast"></div>

  <script>
  (function(){
    // — Firebase init —
    const firebaseConfig = {
      apiKey: "AIzaSyASZrCdc3xrJ8iXagE3iMUdhEpPR5FiJOE",
      authDomain: "masa-tenisi-v1.firebaseapp.com",
      databaseURL: "https://masa-tenisi-v1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "masa-tenisi-v1",
      storageBucket: "masa-tenisi-v1.appspot.com",
      messagingSenderId: "186015084983",
      appId: "1:186015084983:web:86f9d88e907423f5e33832"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // URL params
    const params = new URLSearchParams(location.search);
    const room = params.get('room') || 'main';
    const role = parseInt(params.get('role'),10) || 3;
    const mode = parseInt(params.get('mode'),10) || 1; // not used here but could pass control mode

    // DOM refs
    const A = document.getElementById('arena'),
          P1= document.getElementById('paddle1'),
          P2= document.getElementById('paddle2'),
          B = document.getElementById('ball'),
          S1= document.getElementById('score1'),
          S2= document.getElementById('score2'),
          TP= document.getElementById('touchpad'),
          toast = document.getElementById('toast');

    const W=A.clientWidth, H=A.clientHeight, pw=12, ph=85, br=15, win=5;
    let local = { p1:(H-ph)/2, p2:(H-ph)/2,
                  x:(W-br)/2, y:(H-br)/2,
                  s1:0, s2:0,
                  startTime:Date.now()
                };

    // toast helper
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'),2000);
    }

    // host sets initial state
    if(role===1){
      let vx=5*(Math.random()<0.5?1:-1),
          vy=5*(Math.random()<0.5?1:-1);

      // write initial
      db.ref(`rooms/${room}`).set(local);

      // game loop
      let loop = setInterval(()=>{
        local.x+=vx; local.y+=vy;
        if(local.y<=0||local.y>=H-br) vy=-vy;
        if(local.x<=pw){
          if(local.y+br>local.p1 && local.y<local.p1+ph) vx=-vx;
          else{ local.s2++; resetRound(); }
        }
        if(local.x>=W-br-pw){
          if(local.y+br>local.p2 && local.y<local.p2+ph) vx=-vx;
          else{ local.s1++; resetRound(); }
        }
        if(local.s1>=win||local.s2>=win){
          showToast((local.s1>local.s2?'Player 1':'Player 2')+" kazandı!");
          local.s1=local.s2=0;
          local.startTime=Date.now();
        }
        db.ref(`rooms/${room}`).set(local);
      },16);

      function resetRound(){
        clearInterval(loop);
        showToast("Gol!");
        setTimeout(()=>{
          local.x=(W-br)/2; local.y=(H-br)/2;
          vx=5*(Math.random()<0.5?1:-1);
          vy=5*(Math.random()<0.5?1:-1);
          local.startTime=Date.now();
          loop = setInterval(loop._onTimeout,16);
        },1000);
      }
    }

    // show touchpad if desired
    if(mode===3 && (role===1||role===2)) TP.style.display='block';

    // input → update paddles
    function clamp(v){ return Math.max(0,Math.min(H-ph,v)); }
    function writeP(){
      db.ref(`rooms/${room}`).update(
        role===1?{p1:local.p1}:{p2:local.p2}
      );
    }

    if(role===1||role===2){
      // keyboard
      window.addEventListener('keydown',e=>{
        if(role===1){
          if(e.key==='w') local.p1-=6;
          if(e.key==='s') local.p1+=6;
        }
        if(role===2){
          if(e.key==='ArrowUp') local.p2-=6;
          if(e.key==='ArrowDown') local.p2+=6;
        }
        local.p1=clamp(local.p1);
        local.p2=clamp(local.p2);
        writeP();
      });
      // mouse
      window.addEventListener('mousemove',e=>{
        const r=A.getBoundingClientRect();
        const y=e.clientY-r.top-ph/2;
        if(role===1) local.p1=y;
        else local.p2=y;
        local.p1=clamp(local.p1);
        local.p2=clamp(local.p2);
        writeP();
      });
      // touchpad
      TP.addEventListener('touchmove',e=>{
        e.preventDefault();
        const r=TP.getBoundingClientRect(),
              pct=(e.touches[0].clientX-r.left)/r.width,
              y=pct*(H-ph);
        if(role===1) local.p1=y; else local.p2=y;
        local.p1=clamp(local.p1);
        local.p2=clamp(local.p2);
        writeP();
      });
    }

    // subscribe & render
    db.ref(`rooms/${room}`).on('value', snap=>{
      const st = snap.val();
      if(!st) return;
      P1.style.top=st.p1+'px';
      P2.style.top=st.p2+'px';
      B.style.left=st.x+'px';
      B.style.top=st.y+'px';
      S1.textContent=st.s1;
      S2.textContent=st.s2;
    });
  })();
  </script>
</body>
</html>
