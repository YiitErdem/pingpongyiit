<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Ping Pong JS</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    canvas{background:#111;display:block;margin:0 auto;}
    #touchpad {
      position: fixed;
      bottom: 0; left: 0;
      width: 100%; height: 30%;
      background: rgba(255,255,255,0.05);
      touch-action: none;
    }
    #info {
      position: fixed; top: 10px; left:50%;
      transform: translateX(-50%);
      color: white; font-family: monospace;
    }
  </style>
</head>
<body>
  <div id="info"></div>
  <canvas id="c" width="900" height="600"></canvas>
  <div id="touchpad"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <script>
    // --- URL Parametreleri ---
    const params = new URLSearchParams(location.search);
    const ROOM = params.get('room') || 'room1';
    const ROLE = params.get('role') || 'viewer';
    document.getElementById('info').textContent = `${ROOM.toUpperCase()} — ROLE: ${ROLE}`;

    // --- Firebase init ---
    const cfg = {
      apiKey: "...",
      authDomain: "...",
      databaseURL: "https://masa-tenisi-v1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "masa-tenisi-v1",
      storageBucket: "...",
      messagingSenderId: "...",
      appId: "..."
    };
    const app = firebase.initializeApp(cfg);
    const db  = firebase.database();
    const stateRef = db.ref(`game/${ROOM}/state`);

    // --- Canvas & context ---
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;

    // --- Oyun nesneleri ---
    const P = { w:12, h:85, speed:8 };
    let left  = { y:(H-P.h)/2 };
    let right = { y:(H-P.h)/2 };
    let ball  = { x:W/2, y:H/2, vx:5, vy:5, r:10 };
    let scoreL = 0, scoreR = 0;

    // --- Kullanıcı kontrol modu ---
    let controlMode = 'keyboard'; // 'keyboard'|'mouse'|'touch'
    document.addEventListener('keydown', e => {
      if(e.key==='1') controlMode='keyboard';
      if(e.key==='2') controlMode='mouse';
      if(e.key==='3') controlMode='touch';
    });

    // --- Klavye ---
    const keys = {};
    window.addEventListener('keydown',e=>keys[e.key]=true);
    window.addEventListener('keyup',e=>keys[e.key]=false);

    // --- Mouse ---
    canvas.addEventListener('mousemove', e=>{
      if(controlMode!=='mouse') return;
      const ry = e.clientY - canvas.getBoundingClientRect().top;
      if(ROLE==='player1') left.y = ry-P.h/2;
      if(ROLE==='player2') right.y= ry-P.h/2;
    });

    // --- Touchpad ---
    const tp = document.getElementById('touchpad');
    tp.addEventListener('pointerdown',startTouch);
    tp.addEventListener('pointermove',moveTouch);
    tp.addEventListener('pointerup',endTouch);
    let touching=false, idTouch=null;
    function startTouch(e){
      touching=true; idTouch=e.pointerId; handleTouch(e);
    }
    function moveTouch(e){
      if(!touching||e.pointerId!==idTouch) return;
      handleTouch(e);
    }
    function endTouch(e){
      if(e.pointerId===idTouch) touching=false;
    }
    function handleTouch(e){
      if(controlMode!=='touch') return;
      const ry = e.clientY - canvas.getBoundingClientRect().top;
      if(ROLE==='player1') left.y = ry-P.h/2;
      if(ROLE==='player2') right.y= ry-P.h/2;
    }

    // --- Firebase’dan okuma (tüm roller dinler) ---
    stateRef.on('value', snap=>{
      const s = snap.val();
      if(!s) return;
      Object.assign(left,  { y:s.leftY });
      Object.assign(right, { y:s.rightY });
      Object.assign(ball,  { x:s.ballX, y:s.ballY });
      scoreL = s.scoreL; scoreR = s.scoreR;
    });

    // --- Physics & render ---
    function update(){
      // Sadece oyuncular kendi paddle’ını hareket ettirir:
      if(ROLE==='player1' && controlMode==='keyboard'){
        if(keys['w']) left.y -= P.speed;
        if(keys['s']) left.y += P.speed;
      }
      if(ROLE==='player2' && controlMode==='keyboard'){
        if(keys['ArrowUp']) right.y -= P.speed;
        if(keys['ArrowDown']) right.y += P.speed;
      }
      // sınırlar
      left.y  = Math.max(0, Math.min(H-P.h, left.y));
      right.y = Math.max(0, Math.min(H-P.h, right.y));

      // Fizik GENEL (herkesin bilgisayarında çalışabilir)
      ball.x += ball.vx;
      ball.y += ball.vy;
      if(ball.y<ball.r||ball.y>H-ball.r) ball.vy = -ball.vy;

      // paddle çarpışma
      if(ball.x < P.w+ball.r){
        if(ball.y>left.y && ball.y<left.y+P.h) ball.vx = -ball.vx;
        else { scoreR++; resetBall(); }
      }
      if(ball.x > W-P.w-ball.r){
        if(ball.y>right.y && ball.y<right.y+P.h) ball.vx = -ball.vx;
        else { scoreL++; resetBall(); }
      }

      // Firebase’e yaz (her karede güncel state’i set)
      stateRef.set({
        leftY: left.y,
        rightY: right.y,
        ballX: ball.x,
        ballY: ball.y,
        scoreL, scoreR
      });

      render();
      requestAnimationFrame(update);
    }

    function resetBall(){
      ball.x = W/2; ball.y=H/2;
      // hız rastgele yön
      ball.vx = (Math.random()<0.5?1:-1)*5;
      ball.vy = (Math.random()<0.5?1:-1)*5;
    }

    function render(){
      ctx.clearRect(0,0,W,H);
      // orta çizgi
      ctx.strokeStyle='#555';
      ctx.setLineDash([10,10]);
      ctx.beginPath(); ctx.moveTo(W/2,0); ctx.lineTo(W/2,H); ctx.stroke();
      ctx.setLineDash([]);
      // paddles
      ctx.fillStyle='#fff';
      ctx.fillRect(0, left.y, P.w, P.h);
      ctx.fillRect(W-P.w, right.y, P.w, P.h);
      // top
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.r, 0, 2*Math.PI);
      ctx.fill();
      // skor
      ctx.font='24px monospace';
      ctx.fillText(`${scoreL} – ${scoreR}`, W/2-30, 30);
    }

    resetBall();
    update();
  </script>
</body>
</html>
