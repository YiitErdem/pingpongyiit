<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ping Pong Match</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:Arial,sans-serif;overflow:hidden;background:#111;color:#fff;}
    #toolbar{
      display:flex;justify-content:space-between;align-items:center;
      padding:0.5rem;background:rgba(0,0,0,0.6);
    }
    #toolbar button{background:#222;color:#fff;border:none;padding:0.3rem 0.6rem;
      cursor:pointer;border-radius:4px;}
    #toolbar span{font-size:1.2rem;}
    #canvas{display:block;margin:0 auto;background:#222;}
    #toast{
      position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);
      background:rgba(0,0,0,0.7);padding:0.5rem 1rem;border-radius:4px;
      opacity:0;transition:opacity 0.3s;
    }
  </style>
</head>
<body>

  <div id="toolbar">
    <button id="backBtn">← Lobby</button>
    <span id="scoreDisplay">0 : 0</span>
    <button id="pauseBtn">⏸</button>
  </div>
  <canvas id="canvas" width="800" height="500"></canvas>
  <div id="toast"></div>

  <script>
  // Utils
  function showToast(msg,ms=1000){
    const t=document.getElementById('toast');
    t.textContent=msg; t.style.opacity=1;
    clearTimeout(t._h);
    t._h=setTimeout(()=>t.style.opacity=0,ms);
  }

  // Parse name
  const params=new URLSearchParams(location.search);
  const playerName=params.get('name')||'Oyuncu';

  // State
  const W=800,H=500;
  const P={W:12,H:100,S:400};
  const B={R:8,S:300};
  let state={
    pY:(H-P.H)/2,
    cY:(H-P.H)/2,
    ball:{x:W/2,y:H/2,vx:B.S,vy:B.S},
    s1:0,s2:0,
    paused:false,
    time:120 // seconds
  };

  // Canvas
  const c=document.getElementById('canvas'),ctx=c.getContext('2d');

  // Controls
  let input={};
  c.onmousemove=e=>{
    const r=c.getBoundingClientRect();
    state.pY=Math.max(0,Math.min(H-P.H,e.clientY-r.top-P.H/2));
  };
  c.ontouchmove=e=>{
    e.preventDefault();
    const t=e.touches[0],r=c.getBoundingClientRect();
    state.pY=Math.max(0,Math.min(H-P.H,t.clientY-r.top-P.H/2));
  };

  window.addEventListener('keydown',e=>{
    if(e.key==='w') state.pY-=P.S/30;
    if(e.key==='s') state.pY+=P.S/30;
    if(e.key===' ') state.paused=!state.paused,document.getElementById('pauseBtn').textContent=state.paused?'▶':'⏸';
  });

  // Buttons
  document.getElementById('backBtn').onclick = ()=>location.href='index.html';
  document.getElementById('pauseBtn').onclick = ()=>{
    state.paused=!state.paused;
    document.getElementById('pauseBtn').textContent=state.paused?'▶':'⏸';
  };

  // Physics loop
  let last=performance.now();
  function loop(now){
    const dt=(now-last)/1000; last=now;
    if(!state.paused){
      // Paddle AI
      const tgt=state.ball.y-P.H/2;
      state.cY += Math.sign(tgt-state.cY)*P.S*0.6*dt;
      state.cY=Math.max(0,Math.min(H-P.H,state.cY));
      // Ball
      let b=state.ball;
      b.x+=b.vx*dt; b.y+=b.vy*dt;
      // Walls
      if(b.y<=B.R||b.y>=H-B.R){ b.vy*=-1; showToast('Wall!'); }
      // Paddles
      if(b.x<=P.W+B.R){
        if(b.y>state.pY&&b.y<state.pY+P.H){ b.vx*=-1; showToast('Hit!'); }
        else score(2);
      }
      if(b.x>=W-P.W-B.R){
        if(b.y>state.cY&&b.y<state.cY+P.H){ b.vx*=-1; showToast('Nice!'); }
        else score(1);
      }
      // Timer
      state.time-=dt;
      if(state.time<=0) end();
    }
    render();
    requestAnimationFrame(loop);
  }

  function score(p){
    if(p===1) state.s1++; else state.s2++;
    showToast(`P${p} +1`);
    resetBall();
    if(Math.max(state.s1,state.s2)>=5) end();
  }

  function resetBall(){
    let b=state.ball;
    b.x=W/2; b.y=H/2;
    b.vx=(Math.random()<0.5?-1:1)*B.S;
    b.vy=(Math.random()<0.5?-1:1)*B.S;
  }

  function end(){
    state.paused=true;
    const winner= state.s1>state.s2? playerName:'CPU';
    showToast(`Game Over: ${winner}`,4000);
    // Push to Firebase leaderboard
    try{
      const db=firebase.database();
      db.ref('scores/'+encodeURIComponent(playerName))
        .set({ name:playerName, score:state.s1 });
    }catch{}
  }

  function render(){
    ctx.clearRect(0,0,W,H);
    // paddles
    ctx.fillStyle='#fff';
    ctx.fillRect(0,state.pY,P.W,P.H);
    ctx.fillRect(W-P.W,state.cY,P.W,P.H);
    // ball
    ctx.beginPath();
    ctx.arc(state.ball.x,state.ball.y,B.R,0,2*Math.PI);
    ctx.fill();
    // score
    document.getElementById('scoreDisplay').textContent = 
      `${state.s1} : ${state.s2}`;
  }

  // Start
  resetBall();
  requestAnimationFrame(loop);
  </script>

  <!-- Firebase (re-init for game page) -->
  <script>
    // same config as lobby
    firebase.initializeApp({
      apiKey: "...YOUR CONFIG...",
      authDomain: "...",
      databaseURL: "...default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "masa-tenisi-v1",
    });
  </script>
</body>
</html>
