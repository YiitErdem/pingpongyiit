<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ping Pong Game</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#111; color:#fff; font-family:sans-serif; overflow:hidden; }
    body.theme-neon { background:#000; color:#0ff; }
    #canvas { display:block; margin:0 auto; background:#222; }
    #ui {
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      display:flex; gap:2rem; font-size:1.2rem;
    }
    #controls {  
      position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
      display:none; /* dokunmatikse JS açacak */
      width:80%; height:60px; background:rgba(255,255,255,0.1);
      border-radius:30px; touch-action:none;
    }
    #restartBtn {
      position:absolute; top:10px; right:10px;
      padding:0.5rem 1rem; background:#c00; border:none; color:#fff;
      font-size:1rem; cursor:pointer;
    }
  </style>
</head>
<body>

  <canvas id="canvas" width="900" height="500"></canvas>
  <div id="ui">
    <div>Player 1: <span id="score1">0</span></div>
    <div>Player 2: <span id="score2">0</span></div>
  </div>
  <div id="controls"></div>
  <button id="restartBtn" style="display:none;">Yeniden Başlat</button>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script>
  (async()=>{

    // --- 1) URL’den parametreler
    const params = new URLSearchParams(location.search);
    const tableId  = params.get('table');
    const currentUser = params.get('user');
    const theme = params.get('theme') || 'dark';
    if(!tableId||!currentUser){ alert('Eksik parametre!'); return; }

    document.body.classList.add('theme-'+theme);

    // --- 2) Firebase init
    const cfg = {
      apiKey: "...", authDomain: "...",
      databaseURL: "https://masa-tenisi-v1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "masa-tenisi-v1",
    };
    firebase.initializeApp(cfg);
    const db = firebase.database();

    // --- 3) Refs
    const lobbyRef = db.ref(`lobby/tables/${tableId}`);
    const stateRef = db.ref(`games/${tableId}/state`);

    // --- 4) Canvas & UI
    const canvas = document.getElementById('canvas');
    const ctx    = canvas.getContext('2d');
    const score1El = document.getElementById('score1');
    const score2El = document.getElementById('score2');
    const restartBtn = document.getElementById('restartBtn');
    const controls = document.getElementById('controls');

    // --- 5) Oyun sabitleri
    const W = canvas.width, H = canvas.height;
    const PADDLE_H = 100, PADDLE_W = 12, BALL_R = 10;
    const WIN_SCORE = 7;

    // --- 6) Local state
    let role = null,                  // '1' ya da '2'
        isHost = false,
        state = {                     // DB’den okunacak
          ball:{ x:W/2,y:H/2,dx:5,dy:3 },
          p1:{ y:(H-PADDLE_H)/2 },
          p2:{ y:(H-PADDLE_H)/2 },
          score1:0, score2:0,
          playing:true
        },
        ctrlMode = 'auto';           // 'mouse', 'key', 'touch', 'auto'

    // --- 7) Kullanıcı rolünü al
    const lobbySnap = await lobbyRef.once('value');
    const lobby = lobbySnap.val();
    if(!lobby){ alert('Bu masada oyun bulunamadı.'); return; }
    if(lobby.p1===currentUser) { role='1'; isHost=true; }
    else if(lobby.p2===currentUser) role='2';
    else { alert('Bu masada yeriniz yok.'); return; }

    // --- 8) Eğer host’muş ilk kezse state’i initialize et
    if(isHost){
      await stateRef.set({
        ball: { x:W/2, y:H/2, dx:5, dy:3 },
        p1: { y: (H-PADDLE_H)/2 },
        p2: { y: (H-PADDLE_H)/2 },
        score1:0, score2:0, playing:true
      });
    }

    // --- 9) DB listener
    stateRef.on('value', snap=>{
      const v = snap.val();
      if(v) state=v;
      score1El.textContent = state.score1;
      score2El.textContent = state.score2;
    });

    // --- 10) Kontrol modu otomatik algılama
    if('ontouchstart' in window) ctrlMode='touch';
    else ctrlMode='mouse';
    setupControls();

    // --- 11) Paddle pozisyonu yaz
    function sendPaddleY(y){
      const clamped = Math.max(0, Math.min(H-PADDLE_H, y));
      stateRef.child(`p${role}/y`).set(clamped);
    }

    // --- 12) Çizim
    function draw(){
      ctx.clearRect(0,0,W,H);
      // paddles
      ctx.fillStyle='#fff';
      ctx.fillRect(0, state.p1.y, PADDLE_W, PADDLE_H);
      ctx.fillRect(W-PADDLE_W, state.p2.y, PADDLE_W, PADDLE_H);
      // ball
      ctx.beginPath();
      ctx.arc(state.ball.x, state.ball.y, BALL_R,0,2*Math.PI);
      ctx.fill();

      if(state.playing) requestAnimationFrame(draw);
    }
    draw();

    // --- 13) Host fizik döngüsü
    if(isHost){
      setInterval(()=>{
        if(!state.playing) return;
        let b=state.ball;
        // hareket
        b.x += b.dx; b.y += b.dy;
        // duvar
        if(b.y< BALL_R || b.y>H-BALL_R) b.dy*=-1;
        // paddle1
        if(b.x<=PADDLE_W+BALL_R){
          if(b.y>=state.p1.y && b.y<=state.p1.y+PADDLE_H) b.dx*=-1;
          else pointTo(2);
        }
        // paddle2
        if(b.x>=W-PADDLE_W-BALL_R){
          if(b.y>=state.p2.y && b.y<=state.p2.y+PADDLE_H) b.dx*=-1;
          else pointTo(1);
        }
        // update ball
        stateRef.child('ball').set(b);
      }, 1000/60);
    }

    function pointTo(player){
      // skor
      if(player===1) state.score1++;
      else state.score2++;
      // kazanma?
      if(state.score1>=WIN_SCORE||state.score2>=WIN_SCORE){
        state.playing=false;
        stateRef.update({ score1:state.score1, score2:state.score2, playing:false });
        restartBtn.style.display='block';
      } else {
        // reset ball
        const nv = { x:W/2, y:H/2, dx:5*(Math.random()<0.5?1:-1), dy:3 };
        stateRef.update({
          ball: nv,
          score1: state.score1,
          score2: state.score2
        });
      }
    }

    // --- 14) Restart
    restartBtn.addEventListener('click', ()=>{
      if(!isHost) return;
      stateRef.set({
        ball: { x:W/2, y:H/2, dx:5, dy:3 },
        p1: { y:(H-PADDLE_H)/2 },
        p2: { y:(H-PADDLE_H)/2 },
        score1:0, score2:0, playing:true
      });
      restartBtn.style.display='none';
      // evet, yeniden
    });

    // --- 15) Kontrolleri ayarla
    function setupControls(){
      if(ctrlMode==='mouse'){
        canvas.style.cursor='none';
        canvas.addEventListener('mousemove', e=>{
          const rect=canvas.getBoundingClientRect();
          sendPaddleY(e.clientY-rect.top-PADDLE_H/2);
        });
      } else if(ctrlMode==='touch'){
        controls.style.display='block';
        let dragging=false;
        controls.addEventListener('pointerdown', e=> dragging=true);
        controls.addEventListener('pointerup',   e=> dragging=false);
        controls.addEventListener('pointermove', e=>{
          if(!dragging) return;
          const rect=controls.getBoundingClientRect();
          const pct = (e.clientX-rect.left)/rect.width;
          sendPaddleY(pct*(H-PADDLE_H));
        });
      }
      // ortak: klavye
      window.addEventListener('keydown', e=>{
        if(e.key==='ArrowUp'||e.key==='w'){
          const y = state['p'+role].y - 20;
          sendPaddleY(y);
        }
        if(e.key==='ArrowDown'||e.key==='s'){
          const y = state['p'+role].y + 20;
          sendPaddleY(y);
        }
      });
    }

  })();
  </script>
</body>
</html>
