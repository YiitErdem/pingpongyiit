<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ping Pong Match</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body,html{width:100%;height:100%;background:#111;color:#fff;font-family:sans-serif;overflow:hidden;}
    #canvas{display:block;margin:0 auto;background:#222;border:3px dashed #0ff;}
    #ui{position:absolute;top:10px;left:50%;transform:translateX(-50%);display:flex;gap:2rem;font-size:1.2rem;}
    #timer{position:absolute;top:10px;right:10px;font-size:1.2rem;}
    #controls{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:none;
      width:80%;height:60px;background:rgba(255,255,255,0.1);border-radius:30px;touch-action:none;}
    #startOverlay {
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;
      z-index:10;
    }
    #startOverlay button {
      padding:1rem 2rem;font-size:1.5rem;border:none;border-radius:8px;
      background:#0ff;color:#000;cursor:pointer;
    }
  </style>
</head>
<body>
  <canvas id="canvas" width="900" height="500"></canvas>
  <div id="ui">
    <div><strong id="score1">0</strong> – Player</div>
    <div><strong id="score2">0</strong> – CPU</div>
  </div>
  <div id="timer">02:00</div>
  <div id="controls"></div>
  <div id="startOverlay"><button id="playBtn">Başlat</button></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script>
  (function(){
    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyASZrCdc3xrJ8iXagE3iMUdhEpPR5FiJOE",
      authDomain: "masa-tenisi-v1.firebaseapp.com",
      databaseURL: "https://masa-tenisi-v1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "masa-tenisi-v1",
      storageBucket: "masa-tenisi-v1.appspot.com",
      messagingSenderId: "186015084983",
      appId: "1:186015084983:web:86f9d88e907423f5e33832",
      measurementId: "G-9VSFKH0NS4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const user = new URLSearchParams(location.search).get('user');
    const lbRef = db.ref(`leaderboard/${user}`);

    // Canvas & UI
    const c=document.getElementById('canvas'), ctx=c.getContext('2d');
    const W=c.width, H=c.height;
    const score1El=document.getElementById('score1');
    const score2El=document.getElementById('score2');
    const timerEl=document.getElementById('timer');
    const controls=document.getElementById('controls');
    const startOverlay=document.getElementById('startOverlay');
    const playBtn=document.getElementById('playBtn');

    // Sabitler
    const P_H=100, P_W=12, B_R=10;
    let score1=0, score2=0;
    let timeLeft=120;  // saniye
    let state={ ball:{x:W/2,y:H/2,dx:0,dy:0},
                p1:{y:(H-P_H)/2}, p2:{y:(H-P_H)/2},
                playing:false };
    const buffs=[];

    // Buff üretimi (15sn)
    function spawnBuff(){
      const x=50+Math.random()*(W-100),
            y=50+Math.random()*(H-100),
            types=['grow','shrink','double'];
      buffs.push({x,y,r:15,type:types[Math.floor(Math.random()*3)],used:false});
    }
    setInterval(spawnBuff,15000);

    // Çizim
    function draw(){
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle='#0ff'; ctx.fillRect(0,state.p1.y,P_W,P_H);
      ctx.fillStyle='#f0f'; ctx.fillRect(W-P_W,state.p2.y,P_W,P_H);
      ctx.beginPath(); ctx.fillStyle='#ff0'; ctx.arc(state.ball.x,state.ball.y,B_R,0,2*Math.PI); ctx.fill();
      buffs.forEach(b=>{
        if(!b.used){
          ctx.beginPath();
          ctx.fillStyle = b.type==='grow'? '#0f0' :
                          b.type==='shrink'? '#f00' : '#ff0';
          ctx.arc(b.x,b.y,b.r,0,2*Math.PI);
          ctx.fill();
        }
      });
      if(state.playing) requestAnimationFrame(draw);
    }

    // Topu rastgele başlat
    function resetBall(){
      state.ball.x = W/2; state.ball.y = H/2;
      const sx = Math.random()<0.5?-6:6;
      const sy = Math.random()<0.5?-4:4;
      state.ball.dx = sx; state.ball.dy = sy;
    }

    // Puanlama
    function pointTo(pl){
      if(pl===1) score1++;
      else score2++;
      score1El.textContent=score1;
      score2El.textContent=score2;
      resetBall();
    }

    // FPS döngüsü
    let gameIv;
    function startGameLoop(){
      gameIv = setInterval(()=>{
        // CPU takibi
        state.p2.y += (state.ball.y-(state.p2.y+P_H/2))*0.05;
        state.p2.y = Math.max(0,Math.min(H-P_H,state.p2.y));
        // hareket
        state.ball.x+=state.ball.dx;
        state.ball.y+=state.ball.dy;
        // duvar
        if(state.ball.y<=B_R||state.ball.y>=H-B_R) state.ball.dy*=-1;
        // paddle çarpışma
        if(state.ball.x<=P_W+B_R){
          if(state.ball.y>=state.p1.y && state.ball.y<=state.p1.y+P_H) state.ball.dx*=-1;
          else pointTo(2);
        }
        if(state.ball.x>=W-P_W-B_R){
          if(state.ball.y>=state.p2.y && state.ball.y<=state.p2.y+P_H) state.ball.dx*=-1;
          else pointTo(1);
        }
        // buff alımı
        buffs.forEach(b=>{
          if(!b.used && Math.hypot(state.ball.x-b.x,state.ball.y-b.y)<B_R+b.r){
            b.used=true;
            if(b.type==='grow') P_H*=1.2;
            if(b.type==='shrink') P_H*=0.8;
            if(b.type==='double') state.ball.dx*=1.5;
          }
        });
      },1000/60);
      draw();
    }

    // Zaman sayaç (her saniye)
    let timeIv;
    function startTimer(){
      timeIv = setInterval(()=>{
        if(!state.playing) return;
        if(timeLeft>0){
          timeLeft--;
          const mm=String(Math.floor(timeLeft/60)).padStart(2,'0'),
                ss=String(timeLeft%60).padStart(2,'0');
          timerEl.textContent=`${mm}:${ss}`;
        }
        if(timeLeft===0){
          endMatch();
        }
      },1000);
    }

    // Bitir
    function endMatch(){
      clearInterval(gameIv);
      clearInterval(timeIv);
      state.playing=false;
      const winner = score1>score2?'Player':'CPU';
      alert(`${winner} kazandı!\nSen: ${score1} – CPU: ${score2}`);
      lbRef.transaction(cur=>({ wins:(cur?.wins||0)+(winner==='Player'?1:0) }));
      location.href='index.html';
    }

    // Kontroller
    function sendPaddleY(y){
      state.p1.y = Math.max(0,Math.min(H-P_H,y));
    }
    if('ontouchstart' in window){
      controls.style.display='block';
      let drag=false;
      controls.onpointerdown=()=>drag=true;
      controls.onpointerup=()=>drag=false;
      controls.onpointermove=e=>{ if(!drag) return;
        const pct = (e.clientX-controls.getBoundingClientRect().left)/controls.offsetWidth;
        sendPaddleY(pct*(H-P_H));
      };
    } else {
      c.onmousemove=e=>{
        sendPaddleY(e.clientY-c.getBoundingClientRect().top-P_H/2);
      };
    }

    // Başlat butonu
    playBtn.onclick = ()=>{
      startOverlay.style.display='none';
      resetBall();
      state.playing=true;
      startGameLoop();
      startTimer();
    };

  })();
  </script>
</body>
</html>
