<!DOCTYPE html>
<html>
<head>
  <title>Masa Tenisi - Oyun</title>
  <style>
    canvas {
      background: #f0f0f0;
      display: block;
      margin: 0 auto;
    }
    #scoreBoard {
      text-align: center;
      font-size: 24px;
      margin: 10px;
    }
    #status {
      text-align: center;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div id="scoreBoard">Yukleniyor...</div>
  <div id="status"></div>
  <canvas id="gameCanvas" width="800" height="500"></canvas>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyASZrCdc3xrJ8iXagE3iMUdhEpPR5FiJOE",
      authDomain: "masa-tenisi-v1.firebaseapp.com",
      databaseURL: "https://masa-tenisi-v1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "masa-tenisi-v1",
      storageBucket: "masa-tenisi-v1.appspot.com",
      messagingSenderId: "186015084983",
      appId: "1:186015084983:web:86f9d88e907423f5e33832"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const room = urlParams.get('room');
    const role = urlParams.get('role'); // "player1", "player2", "viewer"

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    let playerY = canvas.height - 20;
    let opponentY = 20;
    let playerScore = 0;
    let opponentScore = 0;

    let paddleWidth = 100;
    let paddleHeight = 10;

    let ball = { x: canvas.width / 2, y: canvas.height / 2, dx: 4, dy: 4, radius: 10 };

    function drawPaddle(x, y) {
      ctx.fillStyle = "black";
      ctx.fillRect(x, y, paddleWidth, paddleHeight);
    }

    function drawBall() {
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
      ctx.fillStyle = "red";
      ctx.fill();
      ctx.closePath();
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawPaddle(playerX, playerY);
      drawPaddle(opponentX, opponentY);
      drawBall();
    }

    let playerX = canvas.width / 2 - paddleWidth / 2;
    let opponentX = canvas.width / 2 - paddleWidth / 2;

    canvas.addEventListener("mousemove", function (e) {
      if (role === "player1" || role === "player2") {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        playerX = mouseX - paddleWidth / 2;
        db.ref(`rooms/${room}/${role}/x`).set(playerX);
      }
    });

    db.ref(`rooms/${room}/player1/x`).on("value", snap => {
      if (role !== "player1") opponentX = snap.val();
    });
    db.ref(`rooms/${room}/player2/x`).on("value", snap => {
      if (role !== "player2") opponentX = snap.val();
    });

    db.ref(`rooms/${room}/ball`).on("value", snap => {
      const b = snap.val();
      if (b) ball = b;
    });

    db.ref(`rooms/${room}/score`).on("value", snap => {
      const s = snap.val();
      if (s) {
        playerScore = role === "player1" ? s.p1 : s.p2;
        opponentScore = role === "player1" ? s.p2 : s.p1;
        document.getElementById("scoreBoard").innerText = `${playerScore} - ${opponentScore}`;
      }
    });

    function updateBall() {
      if (role !== "player1") return;

      ball.x += ball.dx;
      ball.y += ball.dy;

      if (ball.x + ball.radius > canvas.width || ball.x - ball.radius < 0) {
        ball.dx *= -1;
      }

      if (
        ball.y + ball.radius > playerY &&
        ball.x > playerX &&
        ball.x < playerX + paddleWidth
      ) {
        ball.dy *= -1;
      }

      if (
        ball.y - ball.radius < opponentY + paddleHeight &&
        ball.x > opponentX &&
        ball.x < opponentX + paddleWidth
      ) {
        ball.dy *= -1;
      }

      if (ball.y + ball.radius > canvas.height) {
        db.ref(`rooms/${room}/score/p2`).set(opponentScore + 1);
        resetBall();
      }

      if (ball.y - ball.radius < 0) {
        db.ref(`rooms/${room}/score/p1`).set(playerScore + 1);
        resetBall();
      }

      db.ref(`rooms/${room}/ball`).set(ball);
    }

    function resetBall() {
      ball = { x: canvas.width / 2, y: canvas.height / 2, dx: 4, dy: 4, radius: 10 };
    }

    setInterval(() => {
      draw();
      updateBall();
    }, 1000 / 60);
  </script>
</body>
</html>
