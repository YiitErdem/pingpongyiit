<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ping Pong Match</title>
  <link rel="stylesheet" href="styles/game.css">
</head>
<body class="theme-dark">

  <!-- UI & Canvas -->
  <div id="game-toolbar">
    <button id="backLobby">← Lobby</button>
    <span id="score1">0</span> : <span id="score2">0</span>
    <button id="pauseBtn">⏸</button>
  </div>
  <canvas id="canvas"></canvas>
  <div id="toast-container"></div>

  <!-- Audio -->
  <audio id="bgm" loop src="assets/sounds/ambient.mp3"></audio>
  <audio id="sfx-wall" src="assets/sounds/wall.mp3"></audio>
  <audio id="sfx-paddle" src="assets/sounds/paddle.mp3"></audio>
  <audio id="sfx-score" src="assets/sounds/score.mp3"></audio>
  <audio id="sfx-powerup" src="assets/sounds/powerup.mp3"></audio>

  <script type="module">
  import { fixedStepLoop }  from './modules/physics.js';
  import { Toast, vibration } from './modules/ui.js';
  import { AudioManager }    from './modules/audio.js';

  // --- Game constants
  const WIDTH  = 800, HEIGHT = 500;
  const PADDLE = { W:12, H:100, SPEED:400 };
  const BALL   = { R:8, SPEED:300 };
  const TIME_LIMIT = 120;     // seconds
  const POWERUPS = [];        // will be populated dynamically

  // --- Canvas Setup
  const canvas = document.getElementById('canvas');
  const ctx    = canvas.getContext('2d');
  canvas.width  = WIDTH;
  canvas.height = HEIGHT;

  // --- State
  let state = {
    p1Y: (HEIGHT-PADDLE.H)/2,
    p2Y: (HEIGHT-PADDLE.H)/2,
    ball: { x:WIDTH/2, y:HEIGHT/2, vx:BALL.SPEED, vy:BALL.SPEED },
    score1:0, score2:0,
    timer: TIME_LIMIT,
    paused: false
  };

  // --- Audio
  const audio = new AudioManager({
    bgm:     document.getElementById('bgm'),
    wall:    document.getElementById('sfx-wall'),
    paddle:  document.getElementById('sfx-paddle'),
    score:   document.getElementById('sfx-score'),
    powerup: document.getElementById('sfx-powerup'),
  });
  audio.playBgm();

  // --- Input
  let input = { up1:false, down1:false, up2:false, down2:false };
  window.addEventListener('keydown', e=>{
    if (e.key==='w') input.up1=true;
    if (e.key==='s') input.down1=true;
    if (e.key==='ArrowUp') input.up2=true;
    if (e.key==='ArrowDown') input.down2=true;
    if (e.key===' ') { state.paused=!state.paused; }
  });
  window.addEventListener('keyup', e=>{
    if (e.key==='w') input.up1=false;
    if (e.key==='s') input.down1=false;
    if (e.key==='ArrowUp') input.up2=false;
    if (e.key==='ArrowDown') input.down2=false;
  });

  // --- Fixed‑Timestep Physics Loop
  fixedStepLoop(1/60, dt => {
    if (state.paused) return;

    // Paddle Movement
    if (input.up1)   state.p1Y = Math.max(0, state.p1Y - PADDLE.SPEED*dt);
    if (input.down1) state.p1Y = Math.min(HEIGHT-PADDLE.H, state.p1Y + PADDLE.SPEED*dt);
    // CPU for P2
    const target = state.ball.y - PADDLE.H/2;
    state.p2Y += Math.sign(target - state.p2Y) * PADDLE.SPEED*0.6*dt;
    state.p2Y = Math.max(0, Math.min(HEIGHT-PADDLE.H, state.p2Y));

    // Ball Physics
    let b = state.ball;
    b.x += b.vx*dt; b.y += b.vy*dt;
    // Walls
    if (b.y < BALL.R || b.y > HEIGHT-BALL.R) {
      b.vy *= -1; audio.play('wall'); new Toast('Wall hit!',200);
    }
    // Paddles
    if (b.x < PADDLE.W+BALL.R) {
      if (b.y > state.p1Y && b.y < state.p1Y+PADDLE.H) {
        b.vx *= -1; audio.play('paddle'); new Toast('Nice!',150);
      } else score(2);
    }
    if (b.x > WIDTH-PADDLE.W-BALL.R) {
      if (b.y > state.p2Y && b.y < state.p2Y+PADDLE.H) {
        b.vx *= -1; audio.play('paddle'); new Toast('Great!',150);
      } else score(1);
    }

    // Timer
    state.timer -= dt;
    if (state.timer <= 0) endMatch();

    render();
  });

  // --- Score
  function score(player) {
    state[`score${player}`] += 1;
    audio.play('score');
    new Toast(`Player ${player} scored!`, 800);
    resetBall();
    if (Math.max(state.score1, state.score2) >= 5) endMatch();
  }

  // --- Reset Ball
  function resetBall() {
    let b = state.ball;
    b.x = WIDTH/2; b.y = HEIGHT/2;
    b.vx = (Math.random()<0.5?-1:1)*BALL.SPEED;
    b.vy = (Math.random()<0.5?-1:1)*BALL.SPEED;
  }

  // --- End
  function endMatch() {
    state.paused = true;
    audio.stopBgm();
    const winner = state.score1 > state.score2 ? 1 : 2;
    new Toast(`Game Over! Player ${winner} wins.`, 4000);
  }

  // --- Render
  function render(){
    ctx.clearRect(0,0,WIDTH,HEIGHT);
    // Paddles
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, state.p1Y, PADDLE.W, PADDLE.H);
    ctx.fillRect(WIDTH-PADDLE.W, state.p2Y, PADDLE.W, PADDLE.H);
    // Ball
    ctx.beginPath();
    ctx.arc(state.ball.x, state.ball.y, BALL.R,0,2*Math.PI);
    ctx.fill();
    // UI
    document.getElementById('score1').textContent = state.score1;
    document.getElementById('score2').textContent = state.score2;
  }

  // --- Utilities
  document.getElementById('backLobby').onclick = () => {
    audio.stopBgm();
    location.href = 'index.html';
  };

  function endMatch() { /* ... same as above ... */ }

  // Start!
  resetBall();
  </script>
</body>
</html>
