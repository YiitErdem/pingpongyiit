<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Ping Pong – Gelişmiş Fizik</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#000; color:#fff; font-family:sans-serif; overflow:hidden; }
    canvas { display:block; margin:auto; background:#222; }
    #scoreboard {
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      font-size:20px; letter-spacing:2px;
    }
    #message {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      font-size:32px; pointer-events:none;
    }
  </style>
</head>
<body>
  <div id="scoreboard">0 – 0</div>
  <div id="message"></div>
  <canvas id="c" width="900" height="600"></canvas>
  <script>
  (() => {
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;

    // paddle
    const P = { w:12, h:85, speed: 400 };
    const left = { x:0, y:(H-P.h)/2, dy:0 };
    const right = { x:W-P.w, y:(H-P.h)/2, dy:0 };

    // ball
    let ball = { x:W/2, y:H/2, vx:0, vy:0 };
    const BASE_SPEED = 300;
    const MAX_SPEED = 700;
    let rally = 0;

    // physics params
    const MAX_DEFLECT_ANGLE = Math.PI/4; // 45°
    const DAMPING = 0.995;
    const SPIN_FACTOR = 0.3;

    // input
    const keys = {};
    window.addEventListener('keydown', e=>keys[e.key]=true);
    window.addEventListener('keyup',   e=>keys[e.key]=false);

    // score
    let scoreL=0, scoreR=0;
    const sb = document.getElementById('scoreboard');
    const msg= document.getElementById('message');

    // init ball
    function resetBall(winner) {
      ball.x = W/2; ball.y = H/2; rally = 0;
      // kısa mesaj
      if (winner) {
        msg.textContent = winner + ' puan!'; 
        setTimeout(()=> msg.textContent='', 800);
      }
      // rastgele başlangıç yönü
      const angle = (Math.random()*Math.PI/2) - Math.PI/4;
      const dir = (Math.random()<0.5)? 1:-1;
      ball.vx = Math.cos(angle)*BASE_SPEED * dir;
      ball.vy = Math.sin(angle)*BASE_SPEED;
    }

    // çizim
    function draw() {
      // temizle
      ctx.fillStyle = '#000';
      ctx.fillRect(0,0,W,H);
      // orta çizgi
      ctx.strokeStyle = '#555';
      ctx.setLineDash([10,10]);
      ctx.beginPath(); ctx.moveTo(W/2,0); ctx.lineTo(W/2,H); ctx.stroke();
      ctx.setLineDash([]);
      // paddles
      ctx.fillStyle = '#fff';
      ctx.fillRect(left.x, left.y, P.w, P.h);
      ctx.fillRect(right.x,right.y,P.w,P.h);
      // top
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, 10,0,2*Math.PI);
      ctx.fill();
    }

    // güncelleme
    let last = 0;
    function update(dt) {
      // paddle hareket
      left.dy = 0; right.dy = 0;
      if (keys.w) left.dy = -P.speed;
      if (keys.s) left.dy = P.speed;
      if (keys.ArrowUp)    right.dy = -P.speed;
      if (keys.ArrowDown)  right.dy = P.speed;
      left.y += left.dy*dt;
      right.y+= right.dy*dt;
      left.y = Math.max(0, Math.min(H-P.h, left.y));
      right.y= Math.max(0, Math.min(H-P.h, right.y));
      // top hareket
      ball.x += ball.vx*dt;
      ball.y += ball.vy*dt;
      // damping
      ball.vx *= Math.pow(DAMPING, dt*60);
      ball.vy *= Math.pow(DAMPING, dt*60);

      // üst-alt zemin
      if (ball.y<10 || ball.y>H-10) {
        ball.vy = -ball.vy;
      }

      // paddle çarpışmaları
      [[left,1], [right,-1]].forEach(([p,side])=>{
        if (ball.x - 10*side < p.x + (side>0?P.w:0) && 
            ball.x*side > p.x*side &&
            ball.y > p.y && ball.y < p.y+P.h) {
          // offset
          const rel = ((ball.y - (p.y+P.h/2)) / (P.h/2));
          const theta = rel * MAX_DEFLECT_ANGLE;
          // spin
          const spin = p.dy * SPIN_FACTOR;
          // toplam hız büyüklüğü
          rally++;
          const targetSpeed = BASE_SPEED + 
            (MAX_SPEED-BASE_SPEED)*(1 - Math.exp(-rally/10));
          // yeni hız
          ball.vx = Math.cos(theta)* targetSpeed * side;
          ball.vy = Math.sin(theta)* targetSpeed + spin;
        }
      });

      // gol kontrolü
      if (ball.x < 0) {
        scoreR++; sb.textContent = `${scoreL} – ${scoreR}`;
        resetBall('Sağ');
      }
      if (ball.x > W) {
        scoreL++; sb.textContent = `${scoreL} – ${scoreR}`;
        resetBall('Sol');
      }
    }

    // ana döngü
    function loop(ts) {
      if (!last) last = ts;
      const dt = (ts - last)/1000;
      update(dt);
      draw();
      last = ts;
      requestAnimationFrame(loop);
    }

    // başlat
    resetBall();
    requestAnimationFrame(loop);
  })();
  </script>
</body>
</html>
