<!-- game.html (Oyun Sayfası) -->
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Oyun</title>
  <style>
    body { margin: 0; background: #111; color: white; font-family: sans-serif; overflow: hidden; }
    canvas { display: block; margin: 0 auto; background: #333; }
    #score { position: absolute; top: 5px; left: 50%; transform: translateX(-50%); font-size: 24px; }
  </style>
</head>
<body>
<div id="score">Skor: 0 - 0</div>
<canvas id="game" width="800" height="500"></canvas>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, onValue, set, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyASZrCdc3xrJ8iXagE3iMUdhEpPR5FiJOE",
    authDomain: "masa-tenisi-v1.firebaseapp.com",
    databaseURL: "https://masa-tenisi-v1-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "masa-tenisi-v1",
    storageBucket: "masa-tenisi-v1.appspot.com",
    messagingSenderId: "186015084983",
    appId: "1:186015084983:web:86f9d88e907423f5e33832"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const urlParams = new URLSearchParams(window.location.search);
  const roomName = urlParams.get('room') || 'masa1';
  const playerId = Math.random().toString(36).substring(2, 8);
  const playerRole = Math.random() > 0.5 ? 'player1' : 'player2';

  const roomRef = ref(db, `rooms/${roomName}`);
  update(roomRef, {
    [`players/${playerRole}`]: true,
    startedAt: Date.now()
  });

  // Basit skor mekanizması
  let score = { player1: 0, player2: 0 };
  const scoreDiv = document.getElementById('score');
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  let ball = { x: 400, y: 250, dx: 3, dy: 3, r: 10 };

  function updateScoreText() {
    scoreDiv.innerText = `Skor: ${score.player1} - ${score.player2}`;
  }

  onValue(ref(db, `rooms/${roomName}/score`), (snapshot) => {
    if (snapshot.exists()) {
      score = snapshot.val();
      updateScoreText();
    }
  });

  function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'white';
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
    ctx.fill();

    ball.x += ball.dx;
    ball.y += ball.dy;

    if (ball.y < 0 || ball.y > canvas.height) ball.dy *= -1;

    if (ball.x < 0) {
      score.player2++;
      set(ref(db, `rooms/${roomName}/score`), score);
      resetBall();
    }
    if (ball.x > canvas.width) {
      score.player1++;
      set(ref(db, `rooms/${roomName}/score`), score);
      resetBall();
    }

    requestAnimationFrame(gameLoop);
  }

  function resetBall() {
    ball = { x: 400, y: 250, dx: 3 * (Math.random() > 0.5 ? 1 : -1), dy: 3, r: 10 };
  }

  gameLoop();
</script>
</body>
</html>
