<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multiplayer Ping Pong</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; background: #eee; }
    canvas { display: block; margin: auto; background: white; }
    #scoreboard {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      font-size: 24px; font-weight: bold; background: rgba(255,255,255,0.8);
      padding: 10px; border-radius: 10px;
    }
    #lobby {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); color: white; display: flex;
      flex-direction: column; justify-content: center; align-items: center;
    }
    #lobby input, #lobby button {
      margin: 10px; padding: 10px; font-size: 18px;
    }
  </style>
</head>
<body>
<div id="scoreboard">Player 1: 0 | Player 2: 0</div>
<div id="lobby">
  <input type="text" id="roomInput" placeholder="Enter Room Code">
  <button onclick="joinRoom()">Join Room</button>
</div>
<canvas id="gameCanvas" width="800" height="600"></canvas>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyASZrCdc3xrJ8iXagE3iMUdhEpPR5FiJOE",
    authDomain: "masa-tenisi-v1.firebaseapp.com",
    databaseURL: "https://masa-tenisi-v1-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "masa-tenisi-v1",
    storageBucket: "masa-tenisi-v1.appspot.com",
    messagingSenderId: "186015084983",
    appId: "1:186015084983:web:86f9d88e907423f5e33832"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const scoreboard = document.getElementById('scoreboard');
  const lobby = document.getElementById('lobby');

  let room = null;
  let playerNumber = null;
  let gameState = {
    ball: { x: 400, y: 300, vx: 5, vy: 5 },
    paddles: [250, 250],
    score: [0, 0],
    server: 0,
    winner: null
  };

  function draw() {
    ctx.clearRect(0, 0, 800, 600);
    ctx.fillStyle = 'black';
    ctx.fillRect(10, gameState.paddles[0], 10, 100);
    ctx.fillRect(780, gameState.paddles[1], 10, 100);
    ctx.beginPath();
    ctx.arc(gameState.ball.x, gameState.ball.y, 10, 0, Math.PI * 2);
    ctx.fill();
    scoreboard.innerText = `Player 1: ${gameState.score[0]} | Player 2: ${gameState.score[1]}`;
  }

  function updateGame() {
    if (playerNumber !== 0) return;
    let b = gameState.ball;
    b.x += b.vx;
    b.y += b.vy;

    if (b.y <= 10 || b.y >= 590) b.vy *= -1;

    if (b.x <= 20 && b.y > gameState.paddles[0] && b.y < gameState.paddles[0] + 100) b.vx *= -1;
    if (b.x >= 770 && b.y > gameState.paddles[1] && b.y < gameState.paddles[1] + 100) b.vx *= -1;

    if (b.x <= 0) {
      gameState.score[1]++;
      resetBall();
    } else if (b.x >= 800) {
      gameState.score[0]++;
      resetBall();
    }

    if (gameState.score[0] >= 11 || gameState.score[1] >= 11) {
      gameState.winner = gameState.score[0] >= 11 ? 'Player 1' : 'Player 2';
    }

    set(ref(db, `rooms/${room}`), gameState);
  }

  function resetBall() {
    gameState.ball = { x: 400, y: 300, vx: 5 * (Math.random() > 0.5 ? 1 : -1), vy: 5 };
  }

  function gameLoop() {
    draw();
    if (!gameState.winner) updateGame();
    else scoreboard.innerText = `${gameState.winner} Wins!`;
    requestAnimationFrame(gameLoop);
  }

  function joinRoom() {
    room = document.getElementById('roomInput').value;
    lobby.style.display = 'none';
    const roomRef = ref(db, `rooms/${room}`);
    onValue(roomRef, (snapshot) => {
      const data = snapshot.val();
      if (data) gameState = data;
    });
    set(ref(db, `rooms/${room}/paddles`), [250, 250]);
    set(ref(db, `rooms/${room}/score`), [0, 0]);
    set(ref(db, `rooms/${room}/server`), 0);
    set(ref(db, `rooms/${room}/winner`), null);
    set(ref(db, `rooms/${room}/ball`), { x: 400, y: 300, vx: 5, vy: 5 });

    onValue(ref(db, `rooms/${room}/paddles`), (snapshot) => {
      gameState.paddles = snapshot.val();
    });
    onValue(ref(db, `rooms/${room}/score`), (snapshot) => {
      gameState.score = snapshot.val();
    });
    onValue(ref(db, `rooms/${room}/ball`), (snapshot) => {
      gameState.ball = snapshot.val();
    });
    onValue(ref(db, `rooms/${room}/winner`), (snapshot) => {
      gameState.winner = snapshot.val();
    });

    playerNumber = Math.random() > 0.5 ? 0 : 1;
  }

  document.addEventListener('mousemove', (e) => {
    if (playerNumber === null || gameState.winner) return;
    const paddleY = e.clientY - 50;
    gameState.paddles[playerNumber] = Math.max(0, Math.min(500, paddleY));
    set(ref(db, `rooms/${room}/paddles`), gameState.paddles);
  });

  gameLoop();
</script>
</body>
</html>
