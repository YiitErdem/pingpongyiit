<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ping Pong Lobby</title>
  <style>
    /* Reset */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }
    body.theme-neon {
      background: #000;
      color: #0ff;
    }
    body.theme-neon .table-card { border-color: #0ff; }
    body.theme-neon .btn-join { background: #0ff; color: #000; }

    header {
      margin: 1rem;
      text-align: center;
    }

    #loginModal {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.8);
      display: flex; align-items: center; justify-content: center;
      z-index: 10;
    }
    #loginModal .box {
      background: #222; padding:2rem; border-radius:8px;
      width: 90%; max-width: 320px;
    }
    #loginModal select, #loginModal button {
      width: 100%; margin-top:1rem; padding:0.5rem;
      border-radius:4px; border: none;
      font-size: 1rem;
    }

    #tables {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(240px,1fr));
      gap: 1rem;
      width: 90%; max-width: 900px;
      margin-top: 2rem;
    }
    .table-card {
      background: #222;
      border: 2px solid #444;
      border-radius: 8px;
      padding: 1rem;
      display: flex; flex-direction: column;
      justify-content: space-between;
      position: relative;
    }
    .table-card h2 {
      margin-bottom: 0.5rem;
      font-size: 1.25rem;
    }
    .players {
      display: flex;
      justify-content: space-between;
      margin: 1rem 0;
    }
    .players .slot {
      width: 45%;
      min-height: 3rem;
      background: #333;
      border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.9rem;
    }
    .buttons {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .buttons button {
      flex: 1;
      padding: 0.5rem;
      border: none;
      border-radius: 4px;
      background: #28a745;
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    .buttons button:disabled {
      background: #555;
      cursor: not-allowed;
    }

    /* Countdown overlay */
    #countdownOverlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.8);
      display: none; align-items: center; justify-content: center;
      z-index: 20;
      font-size: 5rem; color: #fffa;
    }
  </style>
</head>
<body>

  <header>
    <h1>Ping Pong Lobby</h1>
    <p>Masalardan birine katılın, “Ready” deyin, 3–2–1 geri sayım sonrası oyuna!</p>
  </header>

  <!-- Theme selector ONLY -->
  <div id="loginModal">
    <div class="box">
      <h2>Renk Temasını Seçin</h2>
      <select id="themeSelect">
        <option value="dark">Dark Theme</option>
        <option value="neon">Neon Theme</option>
      </select>
      <button id="btnEnter">Başla</button>
    </div>
  </div>

  <!-- Table cards -->
  <div id="tables"></div>

  <!-- 3-2-1 Countdown -->
  <div id="countdownOverlay"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script>
  (function(){
    // 0) assign or retrieve a unique clientId
    let clientId = localStorage.getItem('clientId');
    if (!clientId) {
      clientId = crypto.randomUUID();
      localStorage.setItem('clientId', clientId);
    }

    // 1) Firebase config + init
    const firebaseConfig = {
      apiKey: "AIzaSyASZrCdc3xrJ8iXagE3iMUdhEpPR5FiJOE",
      authDomain: "masa-tenisi-v1.firebaseapp.com",
      databaseURL: "https://masa-tenisi-v1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "masa-tenisi-v1",
      storageBucket: "masa-tenisi-v1.appspot.com",
      messagingSenderId: "186015084983",
      appId: "1:186015084983:web:86f9d88e907423f5e33832"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const NUM_TABLES = 4;
    let currentTheme = 'dark';

    // DOM refs
    const loginModal = document.getElementById('loginModal');
    const btnEnter    = document.getElementById('btnEnter');
    const themeSelect = document.getElementById('themeSelect');
    const tablesContainer   = document.getElementById('tables');
    const countdownOverlay  = document.getElementById('countdownOverlay');

    // on “Başla”
    btnEnter.onclick = () => {
      currentTheme = themeSelect.value;
      document.body.classList.add('theme-'+currentTheme);
      loginModal.style.display = 'none';
      initLobby();
    };

    async function initLobby() {
      // seed tables if missing
      const rootRef = db.ref('lobby/tables');
      const snap = await rootRef.once('value');
      if (!snap.exists()) {
        const seed = {};
        for (let i=1; i<=NUM_TABLES; i++)
          seed[i] = { p1:null, p2:null, ready1:false, ready2:false };
        await rootRef.set(seed);
      }

      // render table cards
      for (let i=1; i<=NUM_TABLES; i++){
        const card = document.createElement('div');
        card.classList.add('table-card');
        card.dataset.tableId = i;
        card.innerHTML = `
          <h2>Masa ${i}</h2>
          <div class="players">
            <div class="slot" data-slot="1">Boş</div>
            <div class="slot" data-slot="2">Boş</div>
          </div>
          <div class="buttons">
            <button class="btn-join">Katıl</button>
            <button class="btn-ready" disabled>Ready</button>
          </div>
        `;
        tablesContainer.append(card);
      }

      // listen for lobby changes
      db.ref('lobby/tables').on('value', snap => {
        updateLobbyUI(snap.val()||{});
      });

      // button handlers
      tablesContainer.addEventListener('click', e => {
        const card = e.target.closest('.table-card');
        if (!card) return;
        const id = card.dataset.tableId;
        if (e.target.classList.contains('btn-join')) joinTable(id);
        if (e.target.classList.contains('btn-ready')) toggleReady(id);
      });
    }

    function updateLobbyUI(tables){
      document.querySelectorAll('.table-card').forEach(card=>{
        const id = card.dataset.tableId;
        const st = tables[id]||{};
        const slot1 = card.querySelector('.slot[data-slot="1"]');
        const slot2 = card.querySelector('.slot[data-slot="2"]');
        const btnJoin  = card.querySelector('.btn-join');
        const btnReady = card.querySelector('.btn-ready');

        // text: You / Occupied / Empty
        slot1.textContent = (st.p1===clientId ? 'You'
                          : st.p1             ? 'Occupied'
                          : 'Empty');
        slot2.textContent = (st.p2===clientId ? 'You'
                          : st.p2             ? 'Occupied'
                          : 'Empty');

        // join / ready logic
        const mySlot = (st.p1===clientId?'1': st.p2===clientId?'2': null);
        btnJoin.disabled  = !!mySlot || (st.p1 && st.p2);
        btnReady.disabled = !mySlot;
        if (mySlot) {
          btnReady.textContent = st['ready'+mySlot] ? 'Cancel' : 'Ready';
        }

        // if both ready → countdown → game
        if (st.ready1 && st.ready2){
          startCountdown(id);
        }
      });
    }

    let countdownRunning=false;
    function startCountdown(tableId){
      if (countdownRunning) return;
      countdownRunning = true;
      let count = 3;
      countdownOverlay.style.display = 'flex';
      countdownOverlay.textContent = count;
      const iv = setInterval(()=>{
        count--;
        if (count>0) countdownOverlay.textContent = count;
        else {
          clearInterval(iv);
          location.href = `game.html?table=${tableId}&theme=${currentTheme}`;
        }
      },1000);
    }

    function joinTable(tableId){
      const ref = db.ref(`lobby/tables/${tableId}`);
      ref.transaction(cur=>{
        if (!cur) cur = {p1:null,p2:null,ready1:false,ready2:false};
        if (cur.p1===clientId||cur.p2===clientId) return cur;
        if (!cur.p1) cur.p1=clientId;
        else if (!cur.p2) cur.p2=clientId;
        return cur;
      }, (err, committed, snap)=>{
        if (committed){
          const val = snap.val();
          const slot = (val.p1===clientId?'1':'2');
          // drop them on disconnect
          ref.child(`p${slot}`).onDisconnect().set(null);
          ref.child(`ready${slot}`).onDisconnect().set(false);
        }
      });
    }

    function toggleReady(tableId){
      const ref = db.ref(`lobby/tables/${tableId}`);
      ref.transaction(cur=>{
        if (!cur) return;
        const slot = (cur.p1===clientId?'1': cur.p2===clientId?'2': null);
        if (!slot) return;
        cur['ready'+slot] = !cur['ready'+slot];
        return cur;
      });
    }

  })();
  </script>
</body>
</html>
